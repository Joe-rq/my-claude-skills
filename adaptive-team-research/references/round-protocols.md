# 轮次协议详解

> 本文件详细说明每轮协议的执行规范，按模式分别说明 agent 数量、类型选择、并行策略和完成标志。

---

## 三模式流水线架构

### 集中调度模式

```
Round 1（并行）           Round 2（依赖 R1）        Round 3（依赖 R2）
┌──────────┐             ┌───────────────┐         ┌─────────────────┐
│ PM       │──┐          │               │         │                 │
│ (事实)   │  │     ┌───→│ Critic 质询   │────────→│  Team Lead      │
└──────────┘  │     │    │               │         │  直接裁决        │
┌──────────┐  ├─R1──┤    └───────────────┘         │  行动计划        │
│ Designer │──┘ 写  │          ↑ 读画布             └─────────────────┘
│ (事实)   │  画布  │          │                          ↑
└──────────┘       │    Team Lead 自行              Team Lead 整合
┌──────────┐       │    交叉验证（不启动 agent）     Critic 质询
│ Engineer │──┘    │
│ (事实)   │       │
└──────────┘       │

Agent 总数：Round 1 = 3, Round 2 = 1, Round 3 = 0
```

### 领域主导模式

```
Round 1（并行）           Round 2（依赖 R1）        Round 3（依赖 R2）
┌──────────────┐         ┌───────────────┐         ┌─────────────────┐
│ Lead（加深版）│──┐      │ Lead 交叉评审 │──┐      │                 │
│              │  │  ┌──→│               │  │      │  Lead           │
└──────────────┘  │  │   └───────────────┘  ├─────→│  综合裁决        │
┌──────────┐      ├──┤   ┌───────────────┐  │      │  行动计划        │
│ 辅助 1   │──────┘  │   │ Critic 质询   │──┘      └─────────────────┘
│（精简版） │   R1   │   │               │
└──────────┘   写画布 │   └───────────────┘
┌──────────┐         │         ↑ 读画布
│ 辅助 2   │──┘      └────────→│
│（精简版） │
└──────────┘

Agent 总数：Round 1 = 3, Round 2 = 2, Round 3 = 0
```

### 对等协作模式

```
Round 1（并行）           Round 2（依赖 R1）         Round 3（依赖 R2）
┌──────────┐             ┌──────────────────┐       ┌─────────────────┐
│ PM       │──┐     ┌───→│ PM 交叉评论      │──┐    │                 │
│ (事实)   │  │     │    │ Designer 交叉评论 │  │    │  Team Lead      │
└──────────┘  │     │    │ Engineer 交叉评论 │  ├───→│  投票矩阵        │
┌──────────┐  ├─R1──┤    │ Critic 质询      │  │    │  共识收敛        │
│ Designer │──┘ 写  │    └──────────────────┘──┘    │  行动计划        │
│ (事实)   │  画布  │          ↑ 读画布              └─────────────────┘
└──────────┘       │          │
┌──────────┐       │    ┌─────┘
│ Engineer │──┘    └───→│
│ (事实)   │
└──────────┘

Agent 总数：Round 1 = 3, Round 2 = 4, Round 3 = 0
```

---

## Round 1 协议：事实收集

### 目标

收集纯事实，不带主观评价。

### 通用规则（所有模式）

1. 三个 Explore agent 并行启动（PM、Designer、Engineer）
2. 每个 agent 只负责自己的视角领域
3. 输出必须是结构化事实清单，每条附带来源（文件路径:行号）
4. 禁止使用评价性词汇（"好"、"差"、"应该"、"建议"）
5. 所有 agent 使用 `run_in_background: true` 并行执行

### 按模式区分

#### 集中调度

- 三个 agent 均使用**标准版** prompt
- 无差异化处理

#### 领域主导

- Lead 角色使用**加深版** prompt（调研范围更广、维度更多）
- 其余两个角色使用**精简版** prompt（聚焦核心事实）
- Prompt 版本详见 `role-prompts.md`

#### 对等协作

- 三个 agent 均使用**标准版** prompt
- 无差异化处理（与集中调度相同）

### 完成标志

三个 agent 全部返回事实清单。

### Team Lead 动作

1. 收集三份事实清单
2. 复制画布模板到项目目录，替换模板变量
3. 提炼关键事实写入共享画布的 Round 1 区域
4. 确保事实无遗漏但避免冗余

---

## Round 2 协议：交叉辩论

### 目标

交叉验证事实，发现跨领域问题，挑战薄弱论点。

### 按模式区分

#### 集中调度（1 agent）

**启动 agent：**
- Critic × 1

**执行方式：**
1. Team Lead 自行读取三方事实，写交叉评论
2. Critic agent 读取完整画布，对所有三方发起质询
3. Team Lead 不需要格式化的交叉评论输出，直接内化理解

**输出：**
- Team Lead 的交叉评论直接写入画布（非 agent 输出）
- Critic 输出质询列表

#### 领域主导（2 agents）

**启动 agent：**
- Lead 交叉评审 × 1
- Critic × 1

**执行方式：**
1. Lead 交叉评审 agent 读取画布，对其他两方所有发现写 +1/反驳
2. Critic agent 读取画布，对所有三方发起质询
3. 两个 agent 并行执行

**输出：**
- Lead 交叉评审的结构化评论
- Critic 的质询列表

#### 对等协作（4 agents）

**启动 agent：**
- PM 交叉评论者 × 1
- Designer 交叉评论者 × 1
- Engineer 交叉评论者 × 1
- Critic × 1

**执行方式：**
1. 三个交叉评论者各自读取完整画布，对其他两方发现写 +1/反驳
2. Critic 读取完整画布，对所有三方发起质询
3. 四个 agent 并行执行

**输出格式：**
- 交叉评论：`[角色 → 目标角色] 关于 XXX：+1 / 反驳，理由...`
- 交叉发现：`[角色 交叉发现] XXX`
- Critic：`[Critic → 全体] 质询 N：XXX，论据：...`

### 完成标志

所有启动的 agent 全部返回报告。

### Team Lead 动作

1. 收集所有报告
2. 构建投票矩阵：
   - **对等协作**：完整矩阵（议题 × 角色 → +1/反驳），含 Consensus 列
   - **领域主导**：简化矩阵（仅 Lead 评论 + Critic 质询）
   - **集中调度**：简化矩阵（Team Lead 自行评论 + Critic 质询）
3. 提取独到发现和 Critic 质询
4. 写入画布 Round 2 区域

---

## Round 3 协议：共识收敛

### 目标

从辩论中提炼共识和分歧，输出可操作的行动计划。

### 执行者

Team Lead（非 agent），直接在主会话中执行。

### 按模式区分

#### 集中调度：直接裁决

1. 整理 Round 1 事实 + Round 2 Critic 质询
2. Team Lead 对每个议题直接裁决
3. 裁决格式：
   - 议题 → 裁决结论 + 裁决依据
4. 输出行动计划

#### 领域主导：Lead 综合裁决

1. 整理 Round 1 事实 + Round 2 Lead 交叉评审 + Critic 质询
2. Lead 视角权重更高，但需回应 Critic 质询
3. 裁决格式：
   - 议题 → Lead 立场 + Critic 挑战 → 最终裁决
4. 输出行动计划

#### 对等协作：投票矩阵 + 共识收敛

1. 汇总投票矩阵（每个议题各方的 +1/反驳）
2. 共识判定：
   - ✅ 共识：3/4 或 4/4 方同意 → 纳入行动计划
   - ⚡ 分歧：2/4 或更少方同意 → 记录各方立场和理由
3. 对分歧项写"建议决策者权衡"说明
4. 整理被低估的优势（Critic 提醒的）
5. 按 ROI 排序输出行动计划

### 行动计划格式（所有模式通用）

按 ROI 排序：
- **P0**：高价值、低成本（立即执行）
- **P1**：高价值、中等成本（本轮迭代）
- **P2**：中等价值、较高成本（下个周期规划）
- **待定**：需用户确认

每个行动项必须包含：
- 具体行动描述
- 成本估算（来自 Engineer）
- 价值说明
- 负责角色

---

## Agent 类型选择

| 轮次 | Agent 类型 | 理由 |
|------|-----------|------|
| Round 1 | Explore | 只需读取代码，不需要写文件 |
| Round 2 | Explore | 只需读取画布和代码，不需要写文件 |
| Round 3 | Team Lead 自行完成 | 需要写入画布，且是综合判断 |

### 按模式汇总

| 模式 | Round 1 | Round 2 | Round 3 | Agent 总数 |
|------|---------|---------|---------|-----------|
| 集中调度 | 3 × Explore | 1 × Explore（Critic） | Team Lead | **4** |
| 领域主导 | 3 × Explore | 2 × Explore（Lead 交叉 + Critic） | Team Lead | **5** |
| 对等协作 | 3 × Explore | 4 × Explore（3 交叉 + Critic） | Team Lead | **7** |

---

## 性能估算

| 模式 | Round 1 | Round 2 | Round 3 | 总计 |
|------|---------|---------|---------|------|
| 集中调度 | 并行 3 agent | 并行 1 agent + TL 交叉 | TL 裁决 | 最快 |
| 领域主导 | 并行 3 agent | 并行 2 agents | TL 裁决 | 中等 |
| 对等协作 | 并行 3 agent | 并行 4 agents | TL 投票+收敛 | 最慢 |

> 注：所有并行 agent 的耗时 ≈ 最慢的那一个。Round 3 由 Team Lead 完成，无额外 agent 开销。
