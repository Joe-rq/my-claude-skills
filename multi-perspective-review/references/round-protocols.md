# 轮次协议详解

## 三轮流水线架构

```
Round 1（并行）          Round 2（依赖 R1）         Round 3（依赖 R2）
┌──────────┐            ┌──────────────────┐       ┌─────────────────┐
│ PM       │──┐    ┌───→│ PM 交叉评论      │──┐    │                 │
│ (事实)   │  │    │    │ Designer 交叉评论 │  │    │  Team Lead      │
└──────────┘  │    │    │ Engineer 交叉评论 │  ├───→│  共识收敛        │
┌──────────┐  ├─R1─┤    │ Critic 质询      │  │    │  行动计划        │
│ Designer │──┘ 写 │    └──────────────────┘──┘    └─────────────────┘
│ (事实)   │  画布 │           ↑ 读画布
└──────────┘       │           │
┌──────────┐       │    ┌──────┘
│ Engineer │──┘    └───→│
│ (事实)   │            │
└──────────┘            │
```

## Round 1 协议：事实收集

**目标**：收集纯事实，不带主观评价

**规则**：
1. 三个 Explore agent 并行启动（PM、Designer、Engineer）
2. 每个 agent 只负责自己的视角领域
3. 输出必须是结构化事实清单，每条附带来源（文件路径:行号）
4. 禁止使用评价性词汇（"好"、"差"、"应该"、"建议"）
5. 所有 agent 使用 `run_in_background: true` 并行执行

**完成标志**：三个 agent 全部返回事实清单

**Team Lead 动作**：
1. 收集三份事实清单
2. 提炼关键事实写入共享画布的 Round 1 区域
3. 确保事实无遗漏但避免冗余

## Round 2 协议：交叉辩论

**目标**：交叉验证事实，发现跨领域问题，挑战薄弱论点

**规则**：
1. 四个 Explore agent 并行启动（PM 交叉、Designer 交叉、Engineer 交叉、Critic）
2. 每个交叉评论者读取完整画布，对其他两方的发现写 +1 或反驳
3. Critic 读取完整画布，对所有三方发起质询
4. 交叉评论者必须指出被遗漏的跨领域问题
5. Critic 必须为每个质询提供论据

**输出格式**：
- 交叉评论：`[角色 → 目标角色] 关于 XXX：+1 / 反驳，理由...`
- Critic：`[Critic → 全体] 质询 N：XXX，论据：...`

**完成标志**：四个 agent 全部返回评论/质询

## Round 3 协议：共识收敛

**目标**：从辩论中提炼共识和分歧，输出可操作的行动计划

**执行者**：Team Lead（非 agent）

**步骤**：
1. 汇总投票矩阵（每个议题各方的 +1/反驳）
2. 提取共识项（三方以上一致同意的问题）
3. 提取分歧项（未达成一致的问题 + 各方理由）
4. 整理被低估的优势（Critic 提醒的）
5. 按 ROI 排序输出行动计划（优先级 + 成本 + 价值）

**共识判定标准**：
- ✅ 共识：3/4 或 4/4 方同意
- ⚡ 分歧：2/4 或更少方同意
- 分歧项必须附带"建议决策者权衡"的说明

## Agent 类型选择

| 轮次 | Agent 类型 | 理由 |
|------|-----------|------|
| Round 1 | Explore | 只需读取代码，不需要写文件 |
| Round 2 | Explore | 只需读取画布和代码，不需要写文件 |
| Round 3 | Team Lead 自行完成 | 需要写入画布，且是综合判断 |

## 性能优化

- Round 1 三个 agent 并行 → 总耗时 ≈ 最慢的一个（约 5-6 分钟）
- Round 2 四个 agent 并行 → 总耗时 ≈ 最慢的一个（约 3-4 分钟）
- Round 3 由 Team Lead 完成 → 约 2-3 分钟
- 总耗时：约 10-13 分钟（vs 串行方案 30+ 分钟）
